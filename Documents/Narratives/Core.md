# Core Narrative - CiaTc Framework

## Recent Milestones
- **GitHub Repository Published** (Nov 8, 2025): CiaTc framework now public at https://github.com/casuallearning/CiaTc.git
- **Timestamp Performance Issue Identified** (Nov 8, 2025): Despite implementing timestamp-based change detection, agents still regenerating on every invocation (evidence: statusline screenshot showing all agents at 0s simultaneously)
- **Stop Hook Configuration Fixed** (Nov 8, 2025): Identified and fixed Conductor agent filtering issue preventing stop agents from being correctly excluded on UserPromptSubmit hook

## Main Conversation Themes
- Development of a multi-agent critique and analysis system with two-phase architecture: Band (pre-response) and Janitors (post-response)
- Implementation of Band orchestrator (John, George, Pete, Paul, Ringo) for pre-response analysis
- Implementation of Janitor orchestrator (Marie, Descartes, Feynman) for post-response critique with Marie as active maintenance agent
  - Marie: active organizational review and cleanup
  - Descartes: assumption validation and methodical scrutiny
  - Feynman: simplicity advocacy and clarity checking
- Framework for prompt-based AI collaboration patterns with philosophical validation
- Optimization and cleanup of Claude hook orchestration systems for performance
- Selective agent output filtering with careful balance between feedback quality and context overhead
- Paul's experimental development: bio-inspired app architecture leveraging slime mold algorithms and quantum UI patterns
- Paul's design philosophy: Feynman simplicity principle - can we explain complex architectures simply?
- Gilfoyle health monitoring agent integration into Band orchestrator Phase 1 parallel execution (formerly build_health_agent)
- Dependency mapping and maintenance as critical framework infrastructure
- Performance optimization strategy: prioritizing request efficiency over token efficiency (Claude Max x20 subscription model)
- Timestamp-based change detection to prevent unnecessary regeneration (estimated ~300x speedup for unchanged projects)
- WaggleDanceCompiler.swift implementation for waggle dance pattern processing in Core
- Bootstrap initialization system for Band orchestrator (bootstrap_band.py)
- Code simplification initiative: removing complex recursion guard logic to improve maintainability and debuggability
- Janitor hook implementation: post-response critique system that processes all responses through philosophical frameworks
- Recursive janitor processing: band_orchestrator output is captured and fed through janitor critique system
- Integration of janitor critique results for knowledge improvement
- Agent naming evolution: build_health renamed to Gilfoyle for clarity and philosophical alignment
- Stop hook updated with new agent lineup reflecting system architecture changes
- Archive of legacy Janitor prompts to maintain clean project history
- Band agent statusline monitoring: shell scripts for real-time visualization of running agents with elapsed time display
  - band_statusline.sh: monitors lock files in .band_cache/locks to detect active agents and display progress
  - demo_band_statusline.sh: demonstrates statusline output in various agent execution scenarios
  - Visual indicators: emoji icons for each agent (üìÅjohn, üìñgeorge, üîßpete, üí°paul, ü•Åringo, üßπmarie, üèóÔ∏ègilfoyle)
  - Elapsed time tracking: displays seconds or minutes:seconds format for each running agent

## Key Decisions Made
- Separated analysis into "Band" (John, George, Pete, Paul, Ringo) and "Janitors" (Marie, Descartes, Feynman)
- Created modular prompt loading system for scalability
- Established clear role definitions for each AI persona
- Decision to streamline hook output, user requests Paul's output to be included alongside Ringo
- Investigation into hook output chaining patterns in orchestrator scripts
- Band orchestrator output filtering - keeping agent functionality while removing context noise
- Framework now fully operational with parallel agent execution (John & George)
- Successful validation of event JSON formatting and orchestrator response patterns
- Implementation of controlled timeout testing (15-second limit) for orchestrator reliability
- System approaching completion phase with successful Paul output integration
- Paul designated for active experimental development within strict laboratory boundaries
- Paul's "wild ideas" to incorporate Feynman-style thinking: can we explain it simply? (Updated to core philosophy)
- Gilfoyle health agent integrated directly into Band (Phase 1) rather than separate hook - runs parallel with John & George
- User agreement on proposed architecture for Band/Janitor system with philosophical validation
- Recognition that dependency mapping must be maintained as core infrastructure concern
- Systematic review of Gilfoyle requirements vs current implementation to identify enhancement opportunities
- George's output is silently processed (runs in parallel Phase 1) but not displayed in Band report - only updates narrative documents
- Implemented recursion guard in band_orchestrator_main.py to detect and prevent infinite subprocess loops (CIATC_SUBPROCESS environment variable)
- Transitioned from sequential to parallel execution for Phase 1 agents using ThreadPoolExecutor with concurrent.futures
- Focus on measuring and optimizing context token consumption after architectural changes
- Strategic pivot: optimize for request count rather than token consumption given user's Claude Max x20 subscription economics
- Proposed decorator-based timing pattern for fine-grained performance measurement of individual agent functions
- Timestamp-based change detection strategy: agents check if their outputs are newer than inputs before regenerating documentation
- John compares file_index.json mtime against project files; Pete/George compare their output directories against file_index.json mtime
- Renamed build_health_agent to Gilfoyle for philosophical and naming consistency
- Marie activated as primary maintenance agent with Janitor orchestration responsibilities
- Updated Stop hook with new agent lineup and naming conventions
- Legacy Janitor prompts archived to maintain clean, trackable project history
- Marie granted broad organizational authority: proactive file reorganization, cleanup, and structure improvements
- Philosophy established: if Marie's changes temporarily break something, that's feedback on poor initial placement by main agent
- Implemented Band statusline monitoring: shell scripts for real-time visualization of agent execution progress
- Decision to track running agents via lock file monitoring in .band_cache/locks directory
- Visual statusline design: emoji-based agent identifiers with elapsed time display for operational transparency
- **GitHub Publication Initiative**: Converting private project to public open-source framework
  - Completed: Fixed all hardcoded /Users/philhudson paths to relative/generic paths
  - Completed: Added MIT LICENSE file for open-source distribution
  - Completed: Enhanced .gitignore with project-specific patterns (.band_cache, Config, Context, etc)
  - Completed: GitHub repository created at https://github.com/casuallearning/CiaTc.git

## Problems Being Solved
- Need for systematic AI response quality control through multi-perspective analysis
- Requirement for both pre-response (Band) and post-response (Janitors) critique systems
- Creating reusable framework for AI collaboration workflows with philosophical validation
- Hook output redundancy and potential over-processing in orchestrator chains
- Optimizing agent selection for specific workflow requirements
- Maintaining agent processing benefits while reducing Claude context overload
- Framework dependency tracking and architectural visibility for maintainability
- Enhancing build_health_agent to monitor and respond to build/test failures in development workflow (needs name)
- Ensuring Paul's wild ideas incorporate Feynman's simplicity principle: can complex architectures be explained simply?
- Recursion prevention: band orchestrator subprocess invocation and janitor post-response processing
- Ensuring narrative tracking (George) can access conversation context and transcript path via hook event data
- Performance bottleneck identification: granular timing data for individual agent execution
- Unnecessary regeneration overhead: agents regenerating outputs when source files unchanged (wasting ~300x time)
- Code complexity debt: removing overly-complex recursion prevention logic in favor of clarity
- Janitor critique system integration: processing orchestrator output through Marie, Descartes, Feynman perspectives
- Balancing response critique depth against context token overhead
- Determining optimal janitor critique storage and accessibility (temporary files vs persistent logging)
- **SmartOrchestrator initialization delay (1+ minutes)**: Full project scan with rglob and MD5 hashing on every orchestrator init
  - Root cause: Conductor waits for SmartOrchestrator to hash all project files before execution begins
  - Impact: Users experience long delay before Band response begins
  - Identified: Directory mtime approach can short-circuit when project unchanged
- **Statusline real-time updates**: Claude Code polling rate limits (not hook limitation)
  - Hook implementation is correct, but Claude Code doesn't poll statusline continuously
  - Expected behavior: Occasional updates rather than true real-time refresh
  - Acceptable workaround: Current implementation sufficient for visibility
- **Timestamp-based change detection not working**: Agents (George, Pete, others) still regenerating when they shouldn't
  - Evidence: Screenshot shows george:0s, gilfoyle:0s, john:0s, marie:0s, pete:0s all running simultaneously
  - Expected: If narratives newer than file_index, George should skip with "No updates needed"
  - Current behavior: George and other agents running on EVERY invocation despite timestamp checks
  - Root cause investigation needed: Are mtime comparisons failing? Are checks being bypassed?
  - Impact: ~300x performance penalty - agents regenerating unchanged documentation repeatedly
- **Conductor agent selection filtering**: Conductor was incorrectly selecting agents marked as "stop" agents (john, george, pete) on UserPromptSubmit hook
  - Root cause: Filter condition was inverted/incorrect, causing agents with "stop" role to be selected instead of excluded
  - Fix implemented: Corrected filter logic in conductor_agent.py to properly exclude stop agents
  - Status: Fix committed, awaiting validation in next execution cycle

## Direction of Work
- Building comprehensive AI orchestration system with Band (pre-response) and Janitors (post-response) phases - now with Feynman simplicity principle embedded
- Focus on modularity and extensibility of prompt-based agents with philosophical validation
- Integration of janitor post-response critique system into hook orchestration workflow with Marie as active agent
- Streamlining orchestration for efficiency and clarity with performance optimization
- Framework in advanced operational phase with focus on stability and optimization
- **COMPLETED: Fix Conductor agent selection filtering**
  - Conductor was selecting john/george/pete on UserPromptSubmit when it should only select ringo/marie/etc
  - Filter logic corrected and committed
  - Next: Validate fix is working by observing that only correct agents run on UserPromptSubmit
- **PRIORITY: Fix SmartOrchestrator initialization bottleneck**
  - Implement directory mtime fast-path in SmartOrchestrator.scan_project() to skip full hashing on unchanged projects
  - Expected result: eliminate 1+ minute delay on unchanged projects (near-instant on cached state)
  - Trade-off: may miss granular file changes if directory timestamps unreliable
  - Measure impact on typical workflow to validate effectiveness
- **CRITICAL: Fix timestamp-based change detection**
  - Investigate why mtime checks failing: agents running on every invocation despite timestamp guards
  - Review George's timestamp comparison logic in prompts/george.md
  - Review Pete's timestamp comparison logic in prompts/pete.md
  - Review John's file_index.json mtime comparison against project files
  - Expected: agents should return early with status messages when outputs fresh
  - Goal: eliminate ~300x performance penalty from unnecessary regeneration
- **GitHub Publication Complete**: CiaTc framework now public at https://github.com/casuallearning/CiaTc.git
  - Repository live with MIT LICENSE and proper .gitignore
  - All hardcoded paths converted to relative/generic paths for cross-platform compatibility
  - Next: Community documentation, contribution guidelines, and usage examples
- Performance optimization strategy: prioritize request efficiency over token efficiency (Claude Max x20 subscription model)
- Emphasis on speed and parallelism using concurrent execution patterns
- Implementing intelligent caching with timestamp-based change detection (~300x speedup potential)
- Janitor system integration: determining storage strategy for critique output (temp files vs persistent logging)
- Code simplification initiative: removing complex recursion prevention in favor of maintainability
- User preference for simple, debuggable code over robust but complex error handling patterns
- Statusline integration for Band execution progress visualization: real-time display of active agents with elapsed time
  - band_statusline.sh monitors lock files for active agent detection
  - Integration with Claude Code's statusline feature for persistent visibility during long operations
  - Emoji-based visual indicators for quick agent identification
  - Claude Code statusline configuration: mapping user's shell PS1 configuration to statusline display via statusline-setup agent
  - Acknowledged: Claude Code polling rate (not hook) limits real-time refresh - acceptable current implementation
- Paul using Opus model for enhanced complex analysis tasks in Band orchestration
- Paul's architectural input being sought on orchestrator design and optimization opportunities
- Paul's evolution: Feynman thinking now core to wild ideas - all architectures must be explainable simply
- Gilfoyle health agent fully integrated in Phase 1 parallel execution (renamed from build_health)
- Stop hook system updated with new agent lineup reflecting philosophical alignment
- Future enhancement: evaluation of janitor critique results integration into Band learning/improvement cycles
- Legacy system cleanup: archiving old Janitor prompts while maintaining project history
- Empowering Marie with aggressive organizational authority: proactive restructuring, file movement, and cleanup without permission
- Establishing feedback loop: temporary breakage from Marie's reorganization indicates poor initial placement decisions
- Operational visibility: extending Band orchestrator monitoring to show real-time progress in development workflow

## Technical Patterns Emerging
- Two-phase orchestration: Band (pre-response) ‚Üí Response ‚Üí Janitors (post-response)
- Prompt-based agent specialization for focused expertise (Band: analysis; Janitors: critique)
- Orchestrator pattern for AI coordination with phase-based execution
- Shell script activation/deactivation for framework modes
- Modular prompt loading architecture for extensibility
- Silent agent execution with selective output pattern (George, Pete silent; Band shows summary)
- Parallel execution of independent agents using ThreadPoolExecutor
- Standalone script orchestration: agents as separate Python scripts invoked via subprocess
- Philosophical perspective pattern: Janitors apply domain expertise (organization, methodology, clarity)
- Hook event data structure: session_id, transcript_path, cwd, hook_event_name, prompt for context
- Timestamp-based caching: agents check output mtime vs input mtime, return early if fresh (~300x speedup)
- Structured agent response protocol: JSON status objects for orchestrator coordination ("current", "updated", "error")
- Janitor critique system: post-response processing through Marie (active cleanup), Descartes (assumptions), Feynman (simplicity)
- Temporary file-based critique storage: janitor results written to /tmp/janitor_critique.md for next interaction
- Decorator pattern for performance profiling: @timed wrapper for agent execution timing without code modification
- Subscription-optimized architecture: Claude Max x20 economics favor Sonnet parallelism over token minimization
- Status reporting pattern: Band shows phase execution progress with timing information
- Debug mode as development tool: conditional detailed output via DEBUG_MODE environment variable
- Bootstrap pattern: automated Band orchestrator initialization via bootstrap_band.py
- Swift compiler integration: WaggleDanceCompiler.swift for bio-inspired pattern processing
- Feynman simplicity principle: embedded in Paul's prompt - all wild ideas must be explainable simply
- Naming convention pattern: agents named after philosophers/personas with roles tied to expertise (Gilfoyle for health monitoring)
- Prompt archival pattern: legacy prompts archived to maintain clean version history while preserving context
- Lock file monitoring pattern: agents write PID and timestamp to .band_cache/locks/*.lock for state tracking
- Statusline visualization pattern: shell scripts monitor lock files to display active agents with emoji identifiers and elapsed time
- Process validation: statusline checks ps for PID validity to only show genuinely running agents
- Time formatting pattern: elapsed time converted to "Xs" or "XmYs" format for compact readability in statusline
- **SmartOrchestrator optimization pattern**: Replace full-project scan (rglob + MD5 hashing) with directory mtime fast-path to eliminate 1+ minute delays
  - Current bottleneck: SmartOrchestrator.scan_project() recursively hashes ALL files before Conductor runs
  - Optimization: Add directory mtime check as pre-filter to skip full scan when project unchanged
  - Expected improvement: 1+ minute delay ‚Üí near-instant (skipped scan) on unchanged projects
  - Trade-off: May miss granular file changes if directory timestamps don't update consistently
- **Paul using Opus model**: Enhanced for more complex analysis tasks within Band orchestration (upgrade from Sonnet)